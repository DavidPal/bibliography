# Determine the Python version used by the project
if [ -f .python-version ]; then
  PYTHON_VERSION="$(cat .python-version)"
else
  echo "ERROR: .python-version file not found. Create .python-version file first." >&2
  exit 1
fi

# Check if uv is installed.
if ! command -v uv >/dev/null 2>&1; then
  echo "ERROR: uv not found. Install uv first." >&2
  exit 1
fi

# Install Python
uv python install --managed-python "$PYTHON_VERSION"

# Create virtual environment
uv venv --clear --refresh --managed-python --python "$PYTHON_VERSION"

# Install Python dependencies
if [ -f uv.lock ]; then
  uv sync --frozen || uv sync
else
  uv sync
fi

# Add Python and other binaries from virtual environment to PATH
PATH_add ".venv/bin"

# Set VIRTUAL_ENV environment variable
export VIRTUAL_ENV="$PWD/.venv"

watch_file pyproject.toml
watch_file uv.lock
dotenv_if_exists
