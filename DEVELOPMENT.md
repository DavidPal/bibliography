# Installing development tools

Install [`uv`](https://docs.astral.sh/uv/) and [`direnv`](https://direnv.net/).

On MacOS, you can install these tools by running the commands:
```shell
brew install uv
brew install direnv
```

On Ubuntu, you can install them with the commands:
```shell
curl -LsSf https://astral.sh/uv/install.sh | sh
sudo apt install direnv
```

After installing `direnv`, you need to add a line to `~/.bashrc` file or
`~/.zshrc` file. If you are using Bash, add the following line to `~/.bashrc`
```shell
eval "$(direnv hook bash)"
```
If you are using Zsh, add the following line to `~/.bashrc`
```shell
eval "$(direnv hook zsh)"
```
Restart the terminal for the changes to take effect. For more details, please
see [direnv documentation](https://direnv.net/docs/hook.html).

# One-time setup

Change your current working directory to the root of the project using the command
```shell
cd whitespace-format/
```
Run the command
```shell
direnv allow
```
The command instructs `direnv` to automatically trust the instructions in
[`.envrc`](.envrc) file. At the same time, the command executes the commands
[`.envrc`](.envrc). The commands in [`.envrc`](.envrc) install the correct
version of Python, create a virtual environment, and install necessary Python
packages.

The virtual environment is created in `.venv/` subdirectory.

# Running unit tests and code checks

If you make a code change, run unit tests and code checks with the command:
```shell
make clean check-lock-file whitespace-format-check ruff-format-check pydocstyle ruff flake8 pylint mypy test coverage
```
or, for short,
```shell
make clean lint test coverage
```

Each make target runs different checks:
- `clean` deletes temporary files
- `check-lock-file` runs [uv](https://python-poetry.org/docs/) and checks that `uv.lock` file is in sync with `pyproject.toml`
- `whitespace-format-check` runs [whitespace-format](https://github.com/DavidPal/whitespace-format) checker on all files
- `ruff-format-check` runs [ruff](https://github.com/psf/black/) code format checker on `*.py` files
- `pydocstyle` runs [pydocstyle](http://www.pydocstyle.org/) docstring checker on `*.py` files
- `ruff` runs [ruff](https://docs.astral.sh/ruff/) code checker on `*.py` files
- `flake8` runs [flake8](https://flake8.pycqa.org/) code style checker on `*.py` files
- `pylint` runs [pylint](https://pylint.org/) code checker on `*.py` files
- `mypy` runs [mypy](http://mypy-lang.org/) type checker on `*.py` files
- `test` runs unit tests
- `coverage` generates code coverage report
- `lint` runs all checks

You can automatically format code with the command:
```shell
make whitespace-format ruff-format ruff-fix
```

# Managing the virtual environment

You can delete the virtual environment by running the command
```shell
make delete-environment
```
You can re-create the virtual environment by running the command
```shell
make create-environment
```
You can install all necessary Python packages by running the command
```shell
make install-dependencies
```
You can see the list of packages installed in your virtual environment by
running the command
```shell
uv pip list
```

If your Python virtual environment becomes broken or polluted with unnecessary
packages, delete it, recreate it from scratch, and install dependencies afresh
with the following commands:
```shell
make delete-environment
make create-environment
make install-dependencies
```

# Modifying dependencies

The list of Python packages that this project depends on is specified in
[`pyproject.toml`](pyproject.toml) and in [`uv.lock`](uv.lock) files. The file
[`pyproject.toml`](pyproject.toml) can be edited by humans. The file
[`uv.lock`](uv.lock) is automatically generated by `uv`.

Install a development dependency with the command:
```shell
uv add <some_new_python_tool> --dev
```

Install a new production dependency with the command:
```shell
uv add <some_python_library>
```

## Manual modification of [`pyproject.toml`](pyproject.toml)

Instead of using `uv add` command, you can edit
[`pyproject.toml`](pyproject.toml) file. Then, regenerate `uv.lock` file with
the command:
```shell
uv lock
```

## Upgrading packages

Run the command
```shell
uv lock --upgrade
```
The command regenerates `uv.lock` file.

# Releases

Release is made by creating a git tag. Run the following commands:
```shell
git tag X.Y.Z
git tag
git push origin X.Y.Z
```
where `X.Y.Z` is the version in `pyproject.toml` file.

Then, build the package and push it to [pypi](https://pypi.org/) with the
following commands:
```shell
make clean
make build-package
make publish-to-test-pypi
make publish-to-pypi
```
